<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from src/site/markdown/faq.md at 2022-07-08
 | Rendered using Apache Maven Fluido Skin 1.9
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <title>socket.io-client &#x2013; Frequently asked questions</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.9.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script src="./js/apache-maven-fluido-1.9.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <a href="https://github.com/socketio/socket.io-client-java">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"
        alt="Fork me on GitHub">
    </a>
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><div id="bannerLeft"><h2>Socket.IO Java client</h2>
</div>
</div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2022-07-08<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 2.0.2-SNAPSHOT</li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Overview</li>
    <li><a href="installation.html" title="Installation"><span class="none"></span>Installation</a></li>
    <li><a href="initialization.html" title="Initialization"><span class="none"></span>Initialization</a></li>
    <li><a href="emitting_events.html" title="Emitting events"><span class="none"></span>Emitting events</a></li>
    <li><a href="listening_to_events.html" title="Listening to events"><span class="none"></span>Listening to events</a></li>
    <li><a href="socket_instance.html" title="The Socket instance"><span class="none"></span>The Socket instance</a></li>
    <li><a href="migrating_from_1_x.html" title="Migrating from 1.x"><span class="none"></span>Migrating from 1.x</a></li>
    <li><a href="logging.html" title="Logging"><span class="none"></span>Logging</a></li>
    <li class="active"><a href="#"><span class="none"></span>FAQ</a></li>
    <li><a href="android.html" title="Android"><span class="none"></span>Android</a></li>
   <li class="nav-header">Miscellaneous</li>
    <li><a href="changelog.html" title="Changelog"><span class="none"></span>Changelog</a></li>
    <li><a href="apidocs/index.html" title="Javadoc"><span class="none"></span>Javadoc</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <hr />
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<h1>Frequently asked questions</h1>
<ul>
<li><a href="#How_to_deal_with_cookies">How to deal with cookies</a></li>
<li><a href="#How_to_use_with_AWS_Load_Balancing">How to use with AWS Load Balancing</a></li>
<li><a href="#How_to_force_TLS_v1.2_and_above">How to force TLS v1.2 and above</a></li>
<li><a href="#How_to_create_a_lot_of_clients">How to create a lot of clients</a></li>
<li><a href="#How_to_properly_close_a_client">How to properly close a client</a></li></ul>
<section>
<h2><a name="How_to_deal_with_cookies"></a>How to deal with cookies</h2>
<p>In order to store the cookies sent by the server and include them in all subsequent requests, you need to create an OkHttpClient with a custom <a class="externalLink" href="https://square.github.io/okhttp/4.x/okhttp/okhttp3/-cookie-jar/">cookie jar</a>.</p>
<p>You can either implement your own cookie jar:</p>

<div class="source">
<div class="source"><pre class="prettyprint">public class MyApp {

    public static void main(String[] argz) throws Exception {
        IO.Options options = new IO.Options();

        OkHttpClient okHttpClient = new OkHttpClient.Builder()
                .cookieJar(new MyCookieJar())
                .build();

        options.callFactory = okHttpClient;
        options.webSocketFactory = okHttpClient;

        Socket socket = IO.socket(URI.create(&quot;https://example.com&quot;), options);

        socket.connect();
    }

    private static class MyCookieJar implements CookieJar {
        private Set&lt;WrappedCookie&gt; cache = new HashSet&lt;&gt;();

        @Override
        public void saveFromResponse(HttpUrl url, List&lt;Cookie&gt; cookies) {
            for (Cookie cookie : cookies) {
                this.cache.add(new WrappedCookie(cookie));
            }
        }

        @Override
        public List&lt;Cookie&gt; loadForRequest(HttpUrl url) {
            List&lt;Cookie&gt; cookies = new ArrayList&lt;&gt;();
            Iterator&lt;WrappedCookie&gt; iterator = this.cache.iterator();
            while (iterator.hasNext()) {
                Cookie cookie = iterator.next().cookie;
                if (isCookieExpired(cookie)) {
                    iterator.remove();
                } else if (cookie.matches(url)) {
                    cookies.add(cookie);
                }
            }
            return cookies;
        }

        private static boolean isCookieExpired(Cookie cookie) {
            return cookie.expiresAt() &lt; System.currentTimeMillis();
        }
    }

    private static class WrappedCookie {
        private final Cookie cookie;

        public WrappedCookie(Cookie cookie) {
            this.cookie = cookie;
        }

        @Override
        public boolean equals(Object o) {
            if (!(o instanceof WrappedCookie)) return false;
            WrappedCookie that = (WrappedCookie) o;
            return that.cookie.name().equals(this.cookie.name())
                    &amp;&amp; that.cookie.domain().equals(this.cookie.domain())
                    &amp;&amp; that.cookie.path().equals(this.cookie.path())
                    &amp;&amp; that.cookie.secure() == this.cookie.secure()
                    &amp;&amp; that.cookie.hostOnly() == this.cookie.hostOnly();
        }

        @Override
        public int hashCode() {
            int hash = 17;
            hash = 31 * hash + cookie.name().hashCode();
            hash = 31 * hash + cookie.domain().hashCode();
            hash = 31 * hash + cookie.path().hashCode();
            hash = 31 * hash + (cookie.secure() ? 0 : 1);
            hash = 31 * hash + (cookie.hostOnly() ? 0 : 1);
            return hash;
        }
    }
}
</pre></div></div>

<p>Or use a package like <a class="externalLink" href="https://github.com/franmontiel/PersistentCookieJar">PersistentCookieJar</a>:</p>

<div class="source">
<div class="source"><pre class="prettyprint">public class MyApp {

    public static void main(String[] argz) throws Exception {
        IO.Options options = new IO.Options();

        ClearableCookieJar cookieJar = new PersistentCookieJar(new SetCookieCache(), new SharedPrefsCookiePersistor(context));

        OkHttpClient okHttpClient = new OkHttpClient.Builder()
                .cookieJar(cookieJar)
                .build();

        options.callFactory = okHttpClient;
        options.webSocketFactory = okHttpClient;

        Socket socket = IO.socket(URI.create(&quot;https://example.com&quot;), options);

        socket.connect();
    }
}
</pre></div></div>
</section><section>
<h2><a name="How_to_use_with_AWS_Load_Balancing"></a>How to use with AWS Load Balancing</h2>
<p>When scaling to multiple Socket.IO servers, you must ensure that all the HTTP requests of a given session reach the same server (explanation <a class="externalLink" href="https://socket.io/docs/v4/using-multiple-nodes/#why-is-sticky-session-required">here</a>).</p>
<p>Sticky sessions can be enabled on AWS Application Load Balancers, which works by sending a cookie (<code>AWSALB</code>) to the client.</p>
<p>Please see <a href="#how-to-deal-with-cookies">above</a> for how to deal with cookies.</p>
<p>Reference: <a class="externalLink" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/sticky-sessions.html">https://docs.aws.amazon.com/elasticloadbalancing/latest/application/sticky-sessions.html</a></p></section><section>
<h2><a name="How_to_force_TLS_v1.2_and_above"></a>How to force TLS v1.2 and above</h2>
<p>This library relies on the OkHttp library to create HTTP requests and WebSocket connections.</p>
<p>Reference: <a class="externalLink" href="https://square.github.io/okhttp/">https://square.github.io/okhttp/</a></p>
<p>We currently depend on version <code>3.12.12</code>, which is the last version that supports Java 7+ and Android 2.3+ (API level 9+). With this version, the OkHttpClient allows <code>TLSv1</code> and <code>TLSv1.1</code> by default (<a class="externalLink" href="https://square.github.io/okhttp/security/tls_configuration_history/#modern_tls-versions_1">MODERN_TLS</a> configuration).</p>
<p>You can overwrite it by providing your own OkHttp client:</p>

<div class="source">
<div class="source"><pre class="prettyprint">OkHttpClient okHttpClient = new OkHttpClient.Builder()
        .connectionSpecs(Arrays.asList(
            ConnectionSpec.RESTRICTED_TLS
        ))
        .readTimeout(1, TimeUnit.MINUTES) // important for HTTP long-polling
        .build();

IO.Options options = new IO.Options();
options.callFactory = okHttpClient;
options.webSocketFactory = okHttpClient;

Socket socket = IO.socket(URI.create(&quot;https://example.com&quot;), options);
</pre></div></div>

<p>Note: we will upgrade to OkHttp 4 in the next major version.</p></section><section>
<h2><a name="How_to_create_a_lot_of_clients"></a>How to create a lot of clients</h2>
<p>By default, you won&#x2019;t be able to create more than 5 Socket.IO clients (any additional client will be disconnected with &#x201c;transport error&#x201d; or &#x201c;ping timeout&#x201d; reason). That is due to the default OkHttp <a class="externalLink" href="https://square.github.io/okhttp/4.x/okhttp/okhttp3/-dispatcher/">dispatcher</a>, whose <code>maxRequestsPerHost</code> is set to 5 by default.</p>
<p>You can overwrite it by providing your own OkHttp client:</p>

<div class="source">
<div class="source"><pre class="prettyprint">int MAX_CLIENTS = 100;

Dispatcher dispatcher = new Dispatcher();
dispatcher.setMaxRequests(MAX_CLIENTS * 2);
dispatcher.setMaxRequestsPerHost(MAX_CLIENTS * 2);

OkHttpClient okHttpClient = new OkHttpClient.Builder()
        .dispatcher(dispatcher)
        .readTimeout(1, TimeUnit.MINUTES) // important for HTTP long-polling
        .build();

IO.Options options = new IO.Options();
options.callFactory = okHttpClient;
options.webSocketFactory = okHttpClient;

for (int i = 0; i &lt; MAX_CLIENTS; i++) {
    Socket socket = IO.socket(URI.create(&quot;https://example.com&quot;), options);
}
</pre></div></div>

<p>Note: we use <code>MAX_CLIENTS * 2</code> because a client in HTTP long-polling mode will have one long-running GET request for receiving data from the server, and will create a POST request for sending data to the server.</p></section><section>
<h2><a name="How_to_properly_close_a_client"></a>How to properly close a client</h2>
<p>Calling <code>socket.disconnect()</code> may not be sufficient, because the underlying OkHttp client <a class="externalLink" href="https://github.com/square/okhttp/blob/06d38cb795d82d086f13c595a62ce0cbe60904ac/okhttp/src/main/java/okhttp3/Dispatcher.java#L65-L66">creates</a> a ThreadPoolExecutor that will prevent your Java program from quitting for 60 seconds.</p>
<p>As a workaround, you can manually shut down this ThreadPoolExecutor:</p>

<div class="source">
<div class="source"><pre class="prettyprint">Dispatcher dispatcher = new Dispatcher();

OkHttpClient okHttpClient = new OkHttpClient.Builder()
        .dispatcher(dispatcher)
        .readTimeout(1, TimeUnit.MINUTES) // important for HTTP long-polling
        .build();

IO.Options options = new IO.Options();
options.callFactory = okHttpClient;
options.webSocketFactory = okHttpClient;

Socket socket = IO.socket(URI.create(&quot;https://example.com&quot;), options);

socket.connect();

// then later

socket.disconnect();
dispatcher.executorService().shutdown();
</pre></div></div></section>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>&#169;      2022
</p>
        </div>
      </div>
    </footer>
  </body>
</html>
